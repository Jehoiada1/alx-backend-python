// INNER SENTINEL START
// Jenkins pipeline located inside messaging_app/messaging_app
// Stages: Checkout -> Install -> Test -> (Optional) Docker Build & Push
// Relative paths adjusted (manage.py and requirements live one directory up).
// INNER SENTINEL END
pipeline {
  agent any
  environment {
    PYTHON = 'python3'
    APP_ROOT = 'messaging_app'
    OUTER_DIR = '..'
    DOCKER_IMAGE = 'your-dockerhub-username/messaging_app'
    IMAGE_TAG = "${env.BUILD_NUMBER ?: 'local'}"
  }
  options { timestamps(); ansiColor('xterm') }
  stages {
    stage('Checkout') {
      steps {
        git credentialsId: 'github-creds', url: 'https://github.com/Jehoiada1/alx-backend-python.git'
      }
    }
    stage('Install') {
      steps {
        sh "${PYTHON} -m pip install --upgrade pip"
        sh "${PYTHON} -m pip install -r ${OUTER_DIR}/requirements.txt pytest pytest-cov flake8"
      }
    }
    stage('Test') {
      steps {
        sh "cd ${OUTER_DIR} && mkdir -p reports && ${PYTHON} manage.py check && ${PYTHON} manage.py migrate --noinput"
        sh "cd ${OUTER_DIR} && pytest -q --disable-warnings --junitxml=reports/junit.xml --cov=. --cov-report=xml:reports/coverage.xml"
        sh "cd ${OUTER_DIR} && flake8 ."
      }
      post {
        always {
          junit 'messaging_app/reports/junit.xml'
          archiveArtifacts artifacts: 'messaging_app/reports/**', fingerprint: true
        }
      }
    }
    stage('Docker Build & Push') {
      steps {
        script {
          sh "docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} -t ${DOCKER_IMAGE}:latest ${OUTER_DIR}"
          if (env.DOCKERHUB_USERNAME && env.DOCKERHUB_PASSWORD) {
            withCredentials([usernamePassword(credentialsId: 'docker-hub-creds', usernameVariable: 'DH_USER', passwordVariable: 'DH_PASS')]) {
              sh 'echo "$DH_PASS" | docker login -u "$DH_USER" --password-stdin'
              sh 'docker push ${DOCKER_IMAGE}:${IMAGE_TAG}'
              sh 'docker push ${DOCKER_IMAGE}:latest'
            }
          } else {
            echo 'Skipping Docker push (no Docker Hub credentials set).'
          }
        }
      }
    }
  }
}
